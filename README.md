# Matlab Gui for Rover control

This is the guide for using Matlab Gui for the rover.
Through this interface you can initialize a ros network, subscribe to an existing ros network and publish in specific topics.

##  1) Requirements

Requirements for this tools are:

1. Robotics Toolbox for Matlab

https://it.mathworks.com/products/robotics.html

2. GUIDE Toolbox

https://it.mathworks.com/discovery/matlab-gui.html

## 2) Start the Interface

To start the interface, open Matlab, (version between 2014a and 2018b should all be fine) 

1. Type "guide" in the command window.
2. Load the "WAYPOINT_PUB.fig" file by navigating to its folder.
3. Press the green play button.

## 3) Usage

The usage is extremely simple:

### 3.1) Subscribe or Initialize a Ros network

First of all, you must initialize or subscribe to a Ros Network.
In the specific case of the rover, we connect to ROSNET on the Intel Joule and launch the roscore there.
In general, if you setup a network on a PC, and you want to connect to that network follow this procedure:
Make sure that you are connected to the same local network and that you can succesfully ping the computer.

Open a terminal 
```
 $print env | grep URI
```
You should see something like: ROS_MASTER_URI=http://192.1.1.1:11311 
Copy the IP (http://ip:localport) in the ROS INIT box 
Press the ROS INIT button 

Be aware, that if you already initialized or subscribed to a ros network you will se an error on the matlab interface. In that case, just make sure that you press on SHUTDOWN and then try ROS_INIT again.

### 3.2) Publish a Waypoint

To publish a waypoint, write the requested X and Y in the proper boxes, and press Publish.
This will publish a message in the right topic with the proper coordinates.


### 3.3) Safety Switch

The safety switch needs to be enabled to move the rover. The default value is Stop. If you want to move the rover, it must be set to Start.
In case of emergency, you can just publish Stop at any moment.
Do not operate the rover without being ready to press the stop button, otherwise you may cause damage.

# 4) Personalize the interface

The interface consists in two parts: the graphical interface, and the code.
Modification in one of this part will result in modification of the interface as both interfaces are thighly coupled.

The official guide for the "GUIDE toolbox" can be found here: 

https://it.mathworks.com/help/matlab/ref/guide.html

### 4.1) The graphical interface

The graphical interface is made up of buttons, checkboxes, static and dynamic text, graphs.
The usage is based on a very intuitive drag and drop. 
Every button you add, will result in modification of the code. Speficically, every element you add in the graphical interface has one or more function for initialization and callback.
If you double click on an element on the graphical interface a pop up window will open, where you can modify the parameters related to the button you selected.
It is important to notice that in the matlab code, the functions refer to a specific element with its name, which you can find under the Tag voice.
Example:
The dynamic text element for the ip address will be tagged as: ip_address, and the functions in the code referring to it would be:
```
function ip_address_Callback(hObject, eventdata, handles)
function ip_address_CreateFcn(hObject, eventdata, handles)
```

### 4.2) The code 

For this section I am referring to the code in "WaypointPUB.m" 
The code is mostly autogenerated, so most of it will be automatically commented and organized in sections.

The functioning is really simple and mainly performs 2 operation: 
1. Get user input
2. Publish user input in the right format into ROS topics

#### 4.2.1) Get input from Dynamic Text

This is done in ip_address_Callback, xwaypoint_Callback and ywaypoint_Callback.

The format is:
```
something= get(hObject,'Type')
```
Example: 
```
y= get(hObject,'String')
```
#### 4.2.2) Create a Ros Publisher and fill message content

For a more detailed explanation: https://it.mathworks.com/products/robotics.html

The basic functioning is the following:

1. Create a Ros Publisher and select the desired topic

robot = rospublisher('/turtle1/start_and_stop');

2. Declare a message to publish in the right topic.

It can be either done specifically declaring the type of message:
```
Start = rosmessage('std_msgs/Float64')
```
Or by indirectly using the publisher specified above:
```
waypoint = rosmessage(robot);
```
This way Matlab will automatically figure out the right type of message

3. Assign the data to the message respecting ROS message format.
BE AWARE! Matlab messages are identycal to ROS message but to access data inside a Matlab message it has to start with the Capslock.

```
waypoint.X=x
waypoint.Y=y
```
or 
```
Start.Data=1
```
While in ROS it would be:
```
waypoint.x=x or Start.data=1
```

4. Publish the message
```
send("Ros publisher", Ros message")
```

Example:
```
send(robot,waypoint)
```

# Common pitfalls

1. Ros network is already initialized. Make sure to shut down any existing network before initializing a new one.
2. You are publishing in the wrong topics. Always check in the callback functions that topics are consistent.


